{
    # Enable admin API for debugging (be cautious in production)
    admin 0.0.0.0:2019

    # Disable automatic HTTPS (usually handled by external services)
    auto_https off

    # Enhanced logging for debugging
    log {
        format console
        level DEBUG
    }

    # Trust private ranges as proxies (useful in container environments)
    servers {
        trusted_proxies static private_ranges
    }
}

:{$PORT} {
    # Set the root directory
    root * {$SERVE_DIR}

    # Log all requests for debugging
    log

    # Enable compression
    encode gzip zstd

    # Handle Next.js _next directory (static files)
    handle /_next/* {
        file_server
    }

    # Handle static files
    @static {
        file
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.json
    }
    handle @static {
        file_server
        header Cache-Control "public, max-age=3600"
    }

    # Handle API routes and all other requests
    handle {
        reverse_proxy {$NEXT_SERVER:http://localhost:3000} {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Custom error handling
    handle_errors {
        respond "{http.error.status_code} {http.error.message}"
    }
}
