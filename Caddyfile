# Global options
{
    admin off
    auto_https off
    log {
        format json
    }
    servers {
        trusted_proxies static private_ranges
    }
}

:{$PORT} {
    root * {$SERVE_DIR}

    # Handle .well-known directory
    handle /.well-known/* {
        uri strip_prefix /.well-known
        root * {$SERVE_DIR}/.well-known
        file_server
    }

    # Ensure correct MIME type for nostr.json
    header /nostr.json Content-Type application/json

    # Enable compression
    encode gzip zstd

    # Handle Next.js _next directory (static files)
    handle /_next/* {
        file_server
    }

    # Handle static files
    @static {
        file
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.json
    }
    handle @static {
        file_server
        header Cache-Control "public, max-age=3600"
    }

    # Handle API routes
    handle /api/* {
        reverse_proxy localhost:3000
    }

    # Handle all other requests
    handle {
        try_files {path} {path}/index.html
        reverse_proxy localhost:3000
    }

    # Custom error handling
    handle_errors {
        rewrite * /{http.error.status_code}.html
        file_server
        reverse_proxy localhost:3000
    }
}
